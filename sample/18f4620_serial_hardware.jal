-- Title: Test program for serial_hardware.jal
-- Author: Matthew Schinkel - borntechi.com, copyright (c) 2011, all rights reserved.
-- Adapted-by:
-- Compiler: >=2.4o
--
-- This file is part of jallib  (http://jallib.googlecode.com)
-- Released under the BSD license (http://www.opensource.org/licenses/bsd-license.php)
--
-- Description: Test program for serial hardware lib
--
-- Sources:
-- Jallib sample: 18f4550_serial_hardware.jal
--

-- include chip
include 18f4620                   -- target picmicro
pragma target osc INTOSC_NOCLKOUT -- internal oscillator
pragma target clock 32_000_000    -- oscillator frequency
pragma target wdt  disabled
pragma target lvp  disabled
pragma target MCLR external        -- reset externally
--
OSCCON_IRCF = 0b111  -- set internal osc to 8mhz
OSCTUNE_PLLEN = true -- enable PPL, multiply internal osc by 4
--
enable_digital_io()  -- make all pins digital I/O
--
_usec_delay(100_000) -- wait for power to settle


include delay

include print

-- setup uart for communication
const serial_hw_baudrate  = 115200   -- set the baudrate
include serial_hardware
serial_hw_init()
-- some aliases so it is easy to change from serial hw to serial sw.
alias serial_write is serial_hw_write
alias serial_read is serial_hw_read
alias serial_data is serial_hw_data
alias serial_data_available is serial_hw_data_available

const byte str1[] = "Hello serial world"   -- define a string
print_string(serial_hw_data, str1)  -- output string to serial

-- inform user PIC is ready !
serial_hw_write("!")

-- let's build our loop
var byte char	-- will store received char
var word counter = 10
forever loop

   -- if there is a char, echo it back.
	if (serial_hw_read(char))	then
		serial_hw_write(char)	-- that's the echo...
	end if

   -- code block below prints a dot, every now and then, to signal
   -- the pic is alive, waiting to receiver character from the host
	counter = counter - 1      ; count down
	if (counter == 0) then     ; until zero
	   counter = 50000         ; then start over counting from 50000
      serial_hw_data = "."	   ; and output a dot to the serial port
   end if
end loop